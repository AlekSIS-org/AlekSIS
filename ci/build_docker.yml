build_docker:
  stage: build
  image:
    name: buildah/buildah
  script:
    - echo "$CI_REGISTRY_PASSWORD" | buildah login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
    - buildah bud -f Dockerfile -t app .
    - buildah bud -f docker/nginx/Dockerfile -t nginx docker/nginx
    - CONTAINER_ID=$(buildah from app; buildah commit --squash $CONTAINER_ID $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME
    - CONTAINER_ID=$(buildah from nginx; buildah commit --squash $CONTAINER_ID $CI_REGISTRY_IMAG/nginxE:$CI_COMMIT_REF_NAME
    - buildah push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME
    - buildah push $CI_REGISTRY_IMAGE/nginx:$CI_COMMIT_REF_NAME
  only:
    - master
    - tags
